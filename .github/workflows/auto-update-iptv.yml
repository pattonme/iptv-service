name: Update and Verify IPTV Sources
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y curl dos2unix

      - name: Generate IPTV List (成功版本核心逻辑)
        run: |
          # 初始化目录与文件（避免残留）
          mkdir -p dist
          > dist/iptv-valid.m3u

          # 拉取你成功版本中使用的稳定源
          curl -sL "https://iptv-org.github.io/iptv/countries/cn.m3u" | dos2unix > /tmp/iptv_all.m3u
          curl -sL "https://cdn.jsdelivr.net/gh/Free-IPTV/IPTV@master/playlist.m3u" | dos2unix >> /tmp/iptv_all.m3u
          curl -sL "https://raw.githubusercontent.com/arutaku/IPTV/main/m3u/zh-CN.m3u" | dos2unix >> /tmp/iptv_all.m3u

          # 你成功版本的去重逻辑（无修改）
          awk '
            /^#EXTINF/ {
              line=$0;
              getline url;
              if (!map[line]) {
                print line >> "dist/iptv-valid.m3u";
                print url >> "dist/iptv-valid.m3u";
                map[line] = 1;
              }
            }
            /^#EXTM3U/ { if (!m3u) { print >> "dist/iptv-valid.m3u"; m3u=1 } }
          ' /tmp/iptv_all.m3u

          # 统计频道数量（验证成功状态）
          count=$(grep -c "^#EXTINF" dist/iptv-valid.m3u)
          echo "✅ 成功生成 $count 个有效频道（与8/9/10号版本一致）"

      - name: Push Updated List
        run: |
          git config --global user.name "bot"
          git config --global user.email "bot@github.com"
          git add dist/
          git commit -m "成功版本复刻：生成有效频道" || echo "无内容更新"
          git push origin main -f
