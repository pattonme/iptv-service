name: Auto Update IPTV
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          
      - name: Install Tools
        run: sudo apt update -y && sudo apt install -y curl dos2unix

      - name: Run Core Logic
        run: |
          mkdir -p dist
          echo "#EXTM3U" > dist/iptv-valid.m3u
          declare -A channel_map
          
          # 拉取并合并源
          SOURCES=(
            "https://iptv-org.github.io/iptv/countries/cn.m3u"
            "https://cdn.jsdelivr.net/gh/Free-IPTV/IPTV@master/playlist.m3u"
          )
          
          for url in "${SOURCES[@]}"; do
            # 拉取源并处理换行
            curl -sL "$url" | dos2unix > /tmp/temp.m3u
            
            # 逐行解析（用awk替代shell循环，避免read坑）
            awk '
              BEGIN { FS=","; OFS="\n" }
              /^#EXTINF/ { 
                name = $2; gsub(/[ \t\r\n]/, "", name); 
                getline url; gsub(/^[ \t]+|[ \t]+$/, "", url);
                if (url != "" && !map[name]) {
                  print $0, url >> "dist/iptv-valid.m3u";
                  map[name] = 1;
                }
              }
            ' /tmp/temp.m3u
            
            rm -f /tmp/temp.m3u
          done
          
          # 统计频道数
          count=$(grep -c "^#EXTINF" dist/iptv-valid.m3u)
          echo "✅ 生成 $count 个有效频道"

      - name: Push
        run: |
          git config --global user.name "bot"
          git config --global user.email "bot@github.com"
          git add dist/
          git commit -m "update $(date)" || echo "no change"
          git push origin main
