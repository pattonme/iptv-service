name: Auto Update IPTV
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
      - run: sudo apt install -y curl
      - run: |
          mkdir -p scripts && echo '#!/bin/bash
          export TZ="Asia/Shanghai"
          SOURCES=("https://iptv-org.github.io/iptv/countries/cn.m3u" "https://cdn.jsdelivr.net/gh/Free-IPTV/IPTV@master/playlist.m3u")
          mkdir -p dist && echo "#EXTM3U" > dist/iptv-valid.m3u
          declare -A map
          for url in "${SOURCES[@]}"; do
            curl -sL $url | while read -r line; do
              if [[ "$line" =~ ^#EXTINF ]]; then
                read -r u && n=$(echo $line | awk -F, "{print \$2}" | tr -d " ")
                [[ -z "$u" || -n "${map[$n]}" ]] && continue
                map[$n]=1 && echo -e "$line\n$u" >> dist/iptv-valid.m3u
              fi
            done
          done
          echo "✅ 频道数: $(grep -c "^#EXTINF" dist/iptv-valid.m3u)"' > scripts/iptv-checker.sh
      - run: chmod +x scripts/iptv-checker.sh && bash scripts/iptv-checker.sh
      - run: |
          git config --global user.name "bot"
          git config --global user.email "bot@github.com"
          git add dist/ && git commit -m "update" || echo "无更新"
          git push origin main
